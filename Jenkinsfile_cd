pipeline {
        agent any
        environment {
        DOCKER_IMAGE   = 'nurghulam/pso-cicd'
        DOCKER_TAG     = 'latest'
        WEBAPP_NAME    = 'Microsoft.Web-WebApp-Portal-0dcce4b6-bc84'
        RESOURCE_GROUP = 'pso-cicd_group'
        REGISTRY_URL   = 'https://index.docker.io'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/NurGhulam04/fp-pso.git', branch: 'main'
            }
        }

        stage('Deploy to Azure Web App') {
            steps {
                withCredentials([file(credentialsId: 'azure-publish-profile', variable: 'PUBLISH_PROFILE')]) {
                    sh '''
                        echo "Logging in to Azure using publish profile..."
                        az webapp deployment container config \
                        --name "$WEBAPP_NAME" \
                        --resource-group "$RESOURCE_GROUP" \
                        --enable-cd true

                        az webapp config container set \
                        --name "$WEBAPP_NAME" \
                        --resource-group "$RESOURCE_GROUP" \
                        --docker-custom-image-name "$DOCKER_IMAGE:$DOCKER_TAG" \
                        --docker-registry-server-url "$REGISTRY_URL"

                        echo "Deploying Docker image to Azure Web App..."
                        az webapp config container set \
                        --name "$WEBAPP_NAME" \
                        --resource-group "$RESOURCE_GROUP" \
                        --docker-custom-image-name "$DOCKER_IMAGE:$DOCKER_TAG" \
                        --docker-registry-server-url "$REGISTRY_URL"
                    '''
                }
            }
        }
    }
}
