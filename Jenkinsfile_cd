pipeline {
    agent any

    environment {
        DOCKER_IMAGE_NAME = 'nurghulam/pso-cicd' // Your Docker Hub image name
        DOCKER_IMAGE_TAG  = 'latest'             // The tag of the image to deploy
        // AZURE_WEBAPP_NAME = 'perpusgul' // Defined but not directly used in script, HOST is derived from profile
    }

    stages {
        stage('Checkout Source (Optional for CD)') {
            // This stage might be optional if this pipeline is purely for deploying
            // an image already built and pushed by a CI pipeline.
            // If this pipeline is triggered by changes to 'main' and deploys an image
            // also tagged 'latest' from 'main', it's okay.
            steps {
                // Consider cleaning workspace if needed
                // cleanWs()
                git url: 'https://github.com/NurGhulam04/fp-pso.git', branch: 'main'
            }
        }

        stage('Deploy Docker Image to Azure Web App') {
            steps {
                // Ensure xmllint and curl are available on the agent
                // sh 'command -v xmllint >/dev/null 2>&1 || { echo >&2 "xmllint not found. Aborting."; exit 1; }'
                // sh 'command -v curl >/dev/null 2>&1 || { echo >&2 "curl not found. Aborting."; exit 1; }'

                withCredentials([file(credentialsId: 'azure-publish-profile', variable: 'PUBLISH_PROFILE_PATH')]) {
                    sh '''#!/bin/bash
                        set -e
                        set -x

                        echo "Parsing Publish Profile: $PUBLISH_PROFILE_PATH"
                        USERNAME=$(xmllint --xpath "string(//publishProfile[@publishMethod='MSDeploy']/@userName)" "$PUBLISH_PROFILE_PATH")
                        PASSWORD=$(xmllint --xpath "string(//publishProfile[@publishMethod='MSDeploy']/@userPWD)" "$PUBLISH_PROFILE_PATH")
                        # ... baris lainnya ...

                        echo "DEBUG: Raw USERNAME from xmllint is: [$USERNAME]" // Tambahkan ini
                        echo "DEBUG: Raw PASSWORD from xmllint is: [$PASSWORD]" // Tambahkan ini (hati-hati jika log bisa dilihat publik)

                        if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ] || [ -z "$PUBLISH_URL" ]; then
                            echo "Error: Failed to parse credentials or publish URL from publish profile."
                            echo "USERNAME value check: [$USERNAME]" // Tambahkan ini
                            echo "PUBLISH_URL value check: [$PUBLISH_URL]"
                            exit 1
                        fi

                        # ... sisa skrip ...

                        curl -X PUT "https://$HOST/api/settings" \
                            -u "$USERNAME:$PASSWORD" \
                            # ...
                    '''
                }
            }
        }
    }
    post {
        always {
            echo 'Pipeline finished.'
        }
    }
}
