pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'nurghulam/pso-cicd'
        DOCKER_TAG   = 'latest'
        WEBAPP_NAME  = 'PerpusKu'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/NurGhulam04/fp-pso.git', branch: 'main'
            }
        }

        stage('Deploy Docker Image via Publish Profile') {
            steps {
                withCredentials([file(credentialsId: 'azure-publish-profile', variable: 'PUBLISH_PROFILE')]) {
                    sh '''
                        echo "Extracting publish profile credentials..."
                        USERNAME=$(xmllint --xpath "string(//publishProfile[@publishMethod='FTP']/@userName)" $PUBLISH_PROFILE)
                        PASSWORD=$(xmllint --xpath "string(//publishProfile[@publishMethod='FTP']/@userPWD)" $PUBLISH_PROFILE)
                        SITEURL=$(xmllint --xpath "string(//publishProfile[@publishMethod='FTP']/@publishUrl)" $PUBLISH_PROFILE | sed 's/:21//')

                        echo "Setting container image via Azure Web App API..."
                        curl -X PUT "https://$SITEURL/config/web?api-version=2022-03-01" \\
                            -u "$USERNAME:$PASSWORD" \\
                            -H "Content-Type: application/json" \\
                            -d '{
                                "properties": {
                                    "linuxFxVersion": "DOCKER|nurghulam/pso-cicd:latest"
                                }
                            }'
                    '''
                }
            }
        }
    }
}
