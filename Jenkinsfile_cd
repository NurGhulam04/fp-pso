pipeline {
        agent any
        environment {
        DOCKER_IMAGE   = 'nurghulam/pso-cicd'
        DOCKER_TAG     = 'latest'
        WEBAPP_NAME    = 'PerpusKu'
        RESOURCE_GROUP = 'pso-cicd_group'
        REGISTRY_URL   = 'https://index.docker.io'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/NurGhulam04/fp-pso.git', branch: 'main'
            }
        }

       stage('Deploy to Azure Web App') {
            steps {
                withCredentials([file(credentialsId: 'azure-publish-profile', variable: 'PUBLISH_PROFILE')]) {
                    sh '''
                        echo "Authenticating with publish profile..."
                        az webapp config container set \
                            --name "$WEBAPP_NAME" \
                            --resource-group "$RESOURCE_GROUP" \
                            --docker-custom-image-name "$DOCKER_IMAGE:$DOCKER_TAG" \
                            --docker-registry-server-url "$REGISTRY_URL" \
                            --slot-production \
                            --subscription $(az account show --query id -o tsv) \
                            --debug \
                            --profile "$PUBLISH_PROFILE"
                    '''
                }
            }
        }
    }
}
